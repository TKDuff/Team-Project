<html>
<head>
	<link rel="stylesheet" href="studentStyle.css">
	<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.16.0/js/md5.min.js"></script>

</head>
<body>

<h1>Student webpage</h1>
<table border="1" cellpadding="15" id="mytab1">
    <tbody id="CellText">
        <tr>
            <td>Time</td>
            <td>Monday</td>
            <td>Tuesday</td>
            <td>Wednesday</td>
            <td>Thursday</td>
            <td>Friday</td>
        </tr>
        <tr>
            <td>09:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>10:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>11:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>12:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>13:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>14:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>15:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>16:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>17:00</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>


    </tbody>
</table>


<table border="1" cellpadding="15" id="inputBox">
    <tbody>
        <tr>
            <td>Module</td>
            <td>Colour</td>
        </tr>
        <tr>
            <td contenteditable >CS210</td>
            <td onclick="setColour(this)"></td>
        </tr>
        <tr>
            <td contenteditable >CS130</td>
            <td onclick="setColour(this)"></td>
        </tr>
        <tr>
            <td contenteditable >CS240</td>
            <td onclick="setColour(this)"></td>
        </tr>
        <tr>
            <td contenteditable ></td>
            <td onclick="setColour(this)"></td>
        </tr>
        <tr>
            <td contenteditable ></td>
            <td onclick="setColour(this)"></td>
        </tr>
        <tr>
            <td contenteditable ></td>
            <td onclick="setColour(this)"></td>
        </tr>
    </tbody>
</table>

<!--<button type="button" onclick="readUserData()">Read</button>-->


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.12.0/firebase-database.js";


    const firebaseConfig = {

    };

        
    const app = initializeApp(firebaseConfig);  // Initialize Firebase
    const database = getDatabase(app);  // Initialize Realtime Database and get a reference to the service

    var inputBox=document.getElementById("inputBox");
    var table=document.getElementById("mytab1");
    var userTable = document.getElementById("freeTime");
    var moduleColour;
    var moduleCode;
    var r = document.querySelector(':root');


    window.setColour = function(element) {
        var row_index = (element.closest('tr').rowIndex);
        moduleCode = inputBox.rows[row_index].cells[0].innerHTML;
        moduleColour = (md5(moduleCode)).substring(1,7);
        inputBox.rows[row_index].cells[1].style.backgroundColor = moduleColour;
        readUserData(row_index);
    }

    window.readUserData = function (row_index){
        const db = getDatabase();
        const dbRef = ref(db, moduleCode + '/');
        onValue(dbRef, (snapshot) => {const data = snapshot.val();
            const values = Object.entries(data);
            fillInTable(values);
        });   
    }

    window.fillInTable = function(values) {
        var current;
        var column;
        var row;
        var type;
        var currentCell;
        
        for(let index = 0; index < values[0][1].length; index++){
            current = values[0][1][index];
            row = current.charAt(0);
            column = current.charAt(2);
            type = current.substring(4,6);
            currentCell = table.rows[row].cells[column];
            if(currentCell.dataset.modules != null){
                currentCell.setAttribute("data-modules", currentCell.dataset.modules + "," + moduleColour);
                currentCell.setAttribute("data-types", currentCell.dataset.types + "," + type);
                handleClash(currentCell);
            } else {
                currentCell.innerHTML = type;
                currentCell.style.fontFamily = "monospace";
                currentCell.style.backgroundColor = moduleColour;
                currentCell.setAttribute("data-modules", moduleColour);
                currentCell.setAttribute("data-types", type)
                currentCell.setAttribute("onclick", "removeOthers(this)")
            }
                        
        }
    }

    window.handleClash = function(currentCell) {
        var string = currentCell.dataset.types;
        var colours = currentCell.dataset.modules;
        currentCell.innerHTML = "";
        currentCell.style.backgroundColor = "white";
        let stringArray = string.split(",");
        let colourArray = colours.split(",");

        for(let index = 0; index < stringArray.length; index++){
            let div = document.createElement("div");
            div.setAttribute("id", colourArray[index]);
            div.setAttribute("style", "background-color:" + colourArray[index] + ";");
            div.setAttribute("onclick", "removeLabs(this)")
            div.innerHTML = stringArray[index] + " ";
            currentCell.appendChild(div);
        }
    }

    
    window.removeLabs = function(element) {
        var colour = rgba2hex( element.style.backgroundColor);
        var type = element.innerHTML;
        //element.parentNode.style.backgroundColor = colour;
        //element.parentNode.innerHTML = type;

        
        switch(type)
        {
            case "T  ":
                if(element.parentNode.dataset.types.includes("LA")){
                    removeSecondLab(element.parentNode, "white", "");
                }
                element.parentNode.style.backgroundColor = colour;
                element.parentNode.innerHTML = type;                
                break;
            case "LA ":
                console.log("Lab");
                if(element.parentNode.dataset.types.includes("LA")){
                    removeSecondLab(element.parentNode, colour, type);
                }
                element.parentNode.style.backgroundColor = colour;
                element.parentNode.innerHTML = type;
                break;
            default:
                break;
        }
    }

    window.removeOthers = function(element) {
        var currentCell;
        var currentCellRowIndex = (element.closest('tr').rowIndex);
        var currentCellColumnIndex = element.cellIndex;
        for(let row_index = 1; row_index < 9; row_index++){
            for(let cell_index = 1; cell_index < 5; cell_index++){
                currentCell =table.rows[row_index].cells[cell_index];
                var notContested = (element.style.backgroundColor == currentCell.style.backgroundColor) && (currentCellColumnIndex != cell_index) && (currentCellRowIndex != row_index) && (element.innerHTML == currentCell.innerHTML);
                if(notContested){
                    console.log("Clash at ", row_index, cell_index);
                    currentCell.style.backgroundColor = "white";
                    currentCell.innerHTML = "";
                } else if (currentCell.style.backgroundColor == "white"){
                    //console.log("White at ", row_index, cell_index);
                }
            }
        }
        console.log("\n");
    }



    window.removeSecondLab = function(tableCell, colour, type) {
        var nextRow = tableCell.closest('tr').rowIndex;
        var nextCell = table.rows[nextRow+1].cells[tableCell.cellIndex].dataset.modules;
        var move;
        if(nextCell != null ){  //if cell below is not empty, must remove labs from that cell
            move = 1;
        } else {                //else remove from above
            move = -1;
        }
        console.log(move);
        table.rows[nextRow+move].cells[tableCell.cellIndex].innerHTML = type;
        table.rows[nextRow+move].cells[tableCell.cellIndex].style.backgroundColor = colour;
    }




    const rgba2hex = (rgba) => `${rgba.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+\.{0,1}\d*))?\)$/).slice(1).map((n, i) => (i === 3 ? Math.round(parseFloat(n) * 255) : parseFloat(n)).toString(16).padStart(2, '0').replace('NaN', '')).join('')}`



</script>
 
</body>
</html>
